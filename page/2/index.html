<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Jarvis的技术小黑屋">
<meta property="og:url" content="http://smarticeberg.github.io/page/2/index.html">
<meta property="og:site_name" content="Jarvis的技术小黑屋">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jarvis的技术小黑屋">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://smarticeberg.github.io/page/2/"/>





  <title>Jarvis的技术小黑屋</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
<a href="https://github.com/smarticeberg"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jarvis的技术小黑屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">每天学一点东西</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/06/20/Java-proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/20/Java-proxy/" itemprop="url">Java代理机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-20T15:25:50+08:00">
                2018-06-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>动态代理在Java中有着广泛的应用，鼎鼎大名的Spring框架的AOP实现就是基于此项技术。Java的代理分为静态代理和动态代理，区别在于，静态代理的代理关系在编译时就确定，而动态代理的代理关系是在编译期才确定。</p>
<h1 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h1><ul>
<li>JDK代理<ul>
<li>JDK静态代理</li>
<li>JDK动态代理</li>
</ul>
</li>
<li>CGLIB动态代理</li>
</ul>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="JDK-静态代理"><a href="#JDK-静态代理" class="headerlink" title="JDK 静态代理"></a>JDK 静态代理</h2><p>业务接口: <code>UserService.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Iceberg</span><br><span class="line"> * @description 业务接口</span><br><span class="line"> */</span><br><span class="line">public interface UserService &#123;</span><br><span class="line"></span><br><span class="line">	public void addUser();</span><br><span class="line"></span><br><span class="line">	public void editUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>业务实现类: <code>UserServiceImpl.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service.impl;</span><br><span class="line"></span><br><span class="line">import com.jarvis.service.UserService;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Administrator</span><br><span class="line"> * @description 业务实现类</span><br><span class="line"> */</span><br><span class="line">public class UserServiceImpl implements UserService &#123;</span><br><span class="line"></span><br><span class="line">	public void addUser() &#123;</span><br><span class="line">		System.out.println(&quot;增加一个用户&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void editUser() &#123;</span><br><span class="line">		System.out.println(&quot;编辑一个用户&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>业务代理类: <code>UserServiceProxy.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service.proxy;</span><br><span class="line"></span><br><span class="line">import com.jarvis.service.UserService;</span><br><span class="line">import com.jarvis.service.impl.UserServiceImpl;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Iceberg</span><br><span class="line"> * @description 代理类</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class UserServiceProxy implements UserService &#123;</span><br><span class="line"></span><br><span class="line">	private UserServiceImpl userServiceImpl;</span><br><span class="line"></span><br><span class="line">	public UserServiceProxy(UserServiceImpl userServiceImpl) &#123;</span><br><span class="line">		this.userServiceImpl = userServiceImpl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void addUser() &#123;</span><br><span class="line">		System.out.println(&quot;代理方法,在添加用户之前做一些动作。&quot;);</span><br><span class="line">		System.out.println(&quot;事务开启&quot;);</span><br><span class="line">		userServiceImpl.addUser();</span><br><span class="line">		System.out.println(&quot;事务结束&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void editUser() &#123;</span><br><span class="line">		System.out.println(&quot;代理方法,在编辑用户之前做一些动作。&quot;);</span><br><span class="line">		System.out.println(&quot;事务开启&quot;);</span><br><span class="line">		userServiceImpl.editUser();</span><br><span class="line">		System.out.println(&quot;事务结束&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试类: <code>JdkStaticProxyTest.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service;</span><br><span class="line"></span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import com.jarvis.service.impl.UserServiceImpl;</span><br><span class="line">import com.jarvis.service.proxy.UserServiceProxy;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Iceberg</span><br><span class="line"> * @description JDK静态代理测试类</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class JdkStaticProxyTest &#123;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void testJdkStaticProxy() &#123;</span><br><span class="line">		UserServiceImpl serviceImpl = new UserServiceImpl();</span><br><span class="line">		UserServiceProxy proxy = new UserServiceProxy(serviceImpl);</span><br><span class="line">		proxy.addUser();</span><br><span class="line">		System.out.println(&quot;-------------------------------------&quot;);</span><br><span class="line">		proxy.editUser();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">代理方法,在添加用户之前做一些动作。</span><br><span class="line">事务开启</span><br><span class="line">增加一个用户</span><br><span class="line">事务结束</span><br><span class="line">-------------------------------------</span><br><span class="line">代理方法,在添加用户之前做一些动作。</span><br><span class="line">事务开启</span><br><span class="line">编辑一个用户</span><br><span class="line">事务结束</span><br></pre></td></tr></table></figure></p>
<h2 id="JDK-动态代理"><a href="#JDK-动态代理" class="headerlink" title="JDK 动态代理"></a>JDK 动态代理</h2><p>在写代码之前，我们先来了解一些重要关键点。JDK动态代理机制中，有两个重要的类或接口，<code>InvocationHandler(Interface)</code>、<code>Proxy(Class)</code>。这两个是我们事先动态代理所必须用到的。</p>
<ul>
<li>InvocationHandler<blockquote>
<p>InvocationHandler is the interface implemented by the invocation handler of a proxy instance. Each proxy instance has an associated invocation handler. When a method is invoked on a proxy instance, the method invocation is encoded and dispatched to the invoke method of its invocation handler.</p>
</blockquote>
</li>
</ul>
<p>这是Java API文档中对于InvocationHandler接口的描述。大意为：每一个动态代理类都必须实现InvocationHandler这个接口，并且每个代理类的实例都关联到了一个handler，当我们通过代理对象调用一个方法的时候，这个方法的调用就会被转发为由InvocationHandler这个接口invoke方法来进行调用。</p>
<ul>
<li><p>invoke方法</p>
<blockquote>
<p>Object invoke(Object proxy, Method method, Object[] args) throws Throwable</p>
</blockquote>
<ul>
<li>proxy:指代我们所代理的那个真实对象</li>
<li>method:指代的是我们所要调用真实对象的某个方法的Method对象</li>
<li>args:指代的是调用真实对象某个方法时接受的参数</li>
</ul>
</li>
<li><p>Proxy</p>
<blockquote>
<p>Proxy provides static methods for creating dynamic proxy classes and instances, and it is also the superclass of all dynamic proxy classes created by those methods. </p>
</blockquote>
<p>  Proxy这个类的作用就是用来动态创建一个代理对象的类，其newProxyInstance方法最为常用。</p>
<blockquote>
<p>public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces,  InvocationHandler h)  throws IllegalArgumentException</p>
</blockquote>
<ul>
<li>loader:一个ClassLoader对象，定义了由哪个ClassLoader对象来对生成的代理对象进行加载</li>
<li>interfaces:一个Interface对象的数组，表示的是我将要给我需要代理的对象提供一组什么接口，如果我提供了一组接口给它，那么这个代理对象就宣称实现了该接口(多态)，这样我就能调用这组接口中的方法了</li>
<li>h:一个InvocationHandler对象，表示的是当我这个动态代理对象在调用方法的时候，会关联到哪一个InvocationHandler对象上</li>
</ul>
</li>
</ul>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>业务接口: <code>UserService.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Iceberg</span><br><span class="line"> * @description 业务接口</span><br><span class="line"> */</span><br><span class="line">public interface UserService &#123;</span><br><span class="line"></span><br><span class="line">	public void addUser();</span><br><span class="line"></span><br><span class="line">	public void editUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>业务实现类: <code>UserServiceImpl.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service.impl;</span><br><span class="line"></span><br><span class="line">import com.jarvis.service.UserService;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Administrator</span><br><span class="line"> * @description 业务实现类</span><br><span class="line"> */</span><br><span class="line">public class UserServiceImpl implements UserService &#123;</span><br><span class="line"></span><br><span class="line">	public void addUser() &#123;</span><br><span class="line">		System.out.println(&quot;增加一个用户&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void editUser() &#123;</span><br><span class="line">		System.out.println(&quot;编辑一个用户&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JDK动态代理类: <code>UserServiceInvocationHandler.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service.proxy;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Iceberg</span><br><span class="line"> * @description JDK动态代理类</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class UserServiceInvocationHandler implements InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">	// 目标对象</span><br><span class="line">	private Object target;</span><br><span class="line"></span><br><span class="line">	public UserServiceInvocationHandler(Object target) &#123;</span><br><span class="line">		this.target = target;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 创建代理实例</span><br><span class="line">	 * </span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	public Object getProxy() &#123;</span><br><span class="line">		return Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), this.target.getClass().getInterfaces(), this);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">		Object result = null;</span><br><span class="line">		System.out.println(&quot;代理方法，增强功能。&quot;);</span><br><span class="line">		System.out.println(&quot;事务开始&quot;);</span><br><span class="line">		// 执行目标对象方法</span><br><span class="line">		result = method.invoke(target, args);</span><br><span class="line">		System.out.println(&quot;事务结束&quot;);</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试类: <code>JdkProxyTest.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service;</span><br><span class="line"></span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import com.jarvis.service.impl.UserServiceImpl;</span><br><span class="line">import com.jarvis.service.proxy.UserServiceInvocationHandler;</span><br><span class="line"></span><br><span class="line">public class JdkProxyTest &#123;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void jdkProxyTest() &#123;</span><br><span class="line">		UserService service = new UserServiceImpl();</span><br><span class="line">		UserServiceInvocationHandler handler = new UserServiceInvocationHandler(service);</span><br><span class="line">		// 根据目标对象生成代理对象</span><br><span class="line">		UserService proxy = (UserService) handler.getProxy();</span><br><span class="line">		proxy.addUser();</span><br><span class="line">		System.out.println(&quot;--------------------&quot;);</span><br><span class="line">		proxy.editUser();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">代理方法，增强功能。</span><br><span class="line">事务开始</span><br><span class="line">增加一个用户</span><br><span class="line">事务结束</span><br><span class="line">--------------------</span><br><span class="line">代理方法，增强功能。</span><br><span class="line">事务开始</span><br><span class="line">编辑一个用户</span><br><span class="line">事务结束</span><br></pre></td></tr></table></figure></p>
<p>这边我们打印一下代理对象，<code>System.out.println(proxy.getClass().getName());</code>，打印结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.sun.proxy.$Proxy2</span><br></pre></td></tr></table></figure></p>
<p>可能会理所当然的认为这边的对象应该是<code>UserService</code>类型的对象， 或者是<code>InvocationHandler</code>对象，但结果差强人意。整个原因在于newProxyInstance这个方法的第二个参数上，这是我们给代理对象提供一组的接口，代理对象会实现这组接口，所以我们这边可以使用<code>UserService proxy = (UserService) handler.getProxy();</code>来强制类型转化为这组接口的任意一个。<br>同时需要记住一点是<strong>Proxy.newProxyInstance创建的代理对象是在JVM运行时动态生成的一个对象，它并不是InvocationHandler类型，也不是定义的接口类型，命名方式都是以$Proxy+N的形式，最后一个数字N表示对象的符号</strong></p>
<h2 id="CGLIB-动态代理"><a href="#CGLIB-动态代理" class="headerlink" title="CGLIB 动态代理"></a>CGLIB 动态代理</h2><ol>
<li>首先得实现<code>MethodInterceptor</code>，方法调用会被转发到该类的intercept()方法。</li>
<li>使用时通过CGLIB动态获取代理对象</li>
</ol>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><p>业务类: <code>MemberService.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service.impl;</span><br><span class="line"></span><br><span class="line">public class MemberService &#123;</span><br><span class="line"></span><br><span class="line">	public void addMember() &#123;</span><br><span class="line">		System.out.println(&quot;增加会员&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void removeMember() &#123;</span><br><span class="line">		System.out.println(&quot;删除会员&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代理类: <code>MemberServiceCglib.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service.proxy;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">import net.sf.cglib.proxy.Enhancer;</span><br><span class="line">import net.sf.cglib.proxy.MethodInterceptor;</span><br><span class="line">import net.sf.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Iceberg</span><br><span class="line"> * @description CGLIB代理类</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class MemberServiceCglib implements MethodInterceptor &#123;</span><br><span class="line"></span><br><span class="line">	private Object target;</span><br><span class="line"></span><br><span class="line">	public Object getInstance(Object target) &#123;</span><br><span class="line">		this.target = target;</span><br><span class="line">		Enhancer enhancer = new Enhancer();</span><br><span class="line">		enhancer.setSuperclass(this.target.getClass());</span><br><span class="line">		// 设置回调方法</span><br><span class="line">		enhancer.setCallback(this);</span><br><span class="line">		// 创建代理对象</span><br><span class="line">		return enhancer.create();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable &#123;</span><br><span class="line">		System.out.println(&quot;代理方法，增强功能。&quot;);</span><br><span class="line">		System.out.println(&quot;事务开始&quot;);</span><br><span class="line">		Object result = proxy.invokeSuper(obj, args);</span><br><span class="line">		System.out.println(&quot;事务结束&quot;);</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试类: <code>CglibProxyTest.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.service;</span><br><span class="line"></span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import com.jarvis.service.impl.MemberService;</span><br><span class="line">import com.jarvis.service.proxy.MemberServiceCglib;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Iceberg</span><br><span class="line"> * @description CGLIB代理测试类</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class CglibProxyTest &#123;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void cglibProxyTest() &#123;</span><br><span class="line">		MemberServiceCglib cglib = new MemberServiceCglib();</span><br><span class="line">		MemberService memberService = (MemberService) cglib.getInstance(new MemberService());</span><br><span class="line">		memberService.addMember();</span><br><span class="line">		System.out.println(&quot;----------------&quot;);</span><br><span class="line">		memberService.removeMember();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">代理方法，增强功能。</span><br><span class="line">事务开始</span><br><span class="line">增加会员</span><br><span class="line">事务结束</span><br><span class="line">----------------</span><br><span class="line">代理方法，增强功能。</span><br><span class="line">事务开始</span><br><span class="line">删除会员</span><br><span class="line">事务结束</span><br></pre></td></tr></table></figure></p>
<p>如果业务类被定义成final类型的， 则会报如下错误:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Cannot subclass final class class com.jarvis.service.impl.MemberService</span><br><span class="line">	at net.sf.cglib.proxy.Enhancer.generateClass(Enhancer.java:446)</span><br><span class="line">	at net.sf.cglib.core.DefaultGeneratorStrategy.generate(DefaultGeneratorStrategy.java:25)</span><br><span class="line">	at net.sf.cglib.core.AbstractClassGenerator.create(AbstractClassGenerator.java:216)</span><br><span class="line">	at net.sf.cglib.proxy.Enhancer.createHelper(Enhancer.java:377)</span><br><span class="line">	at net.sf.cglib.proxy.Enhancer.create(Enhancer.java:285)</span><br><span class="line">	at com.jarvis.service.proxy.MemberServiceCglib.getInstance(MemberServiceCglib.java:25)</span><br><span class="line">	at com.jarvis.service.CglibProxyTest.cglibProxyTest(CglibProxyTest.java:18)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)</span><br><span class="line">	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)</span><br><span class="line">	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)</span><br><span class="line">	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)</span><br><span class="line">	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)</span><br><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)</span><br><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)</span><br><span class="line">	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)</span><br><span class="line">	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)</span><br><span class="line">	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)</span><br><span class="line">	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)</span><br><span class="line">	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)</span><br><span class="line">	at org.junit.runners.ParentRunner.run(ParentRunner.java:309)</span><br><span class="line">	at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:86)</span><br><span class="line">	at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)</span><br><span class="line">	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:459)</span><br><span class="line">	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:678)</span><br><span class="line">	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:382)</span><br><span class="line">	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:192)</span><br></pre></td></tr></table></figure></p>
<h1 id="常见动态代理场景"><a href="#常见动态代理场景" class="headerlink" title="常见动态代理场景"></a>常见动态代理场景</h1><ul>
<li>Spring AOP</li>
<li>Hibernate懒加载查询</li>
<li>Dubbo消费者初始化</li>
</ul>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><ul>
<li>JDK静态代理<br>这个比较简单，直接代理对象包装了被代理对象</li>
<li>JDK动态代理<br>JDK动态代理是<strong>接口代理</strong>，被代理的类需要实现业务接口，代理类需要实现InvocationHandler接口。同时，JDK动态代理会根据被代理对象生成一个继承Proxy的代理类，并实现了业务接口。该类的字节码会被ClassLoader加载，创建代理对象的实例。JDK代理对象实例在创建时，业务代理对象实例会被赋值给Proxy类，JDK代理对象实例也就有了业务代理对象的实例，同时JDK代理对象实例通过反射根据被代理类的业务方法创建了相应的Method对象m（可能有多个）。当JDK代理对象实例调用业务方法，如proxy.addUser();这个会先把对应的m对象作为参数传给invoke()方法（就是invoke方法的第二个参数），调用了JDK代理对象实例的invoke()回调方法，在invoke方法里面再通过反射来调用被代理对象的因为方法，即result = method.invoke(target, args);。</li>
<li>CGLIB动态代理是<strong>继承代理</strong>，通过ASM来修改字节码生成新的子类，重写并增强方法。</li>
</ul>
<h1 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h1><ul>
<li>JDK静态代理只能服务于一个被代理类，如果需要代理的类比较多的情况下，就会产生很多的代理类。JDK静态代理的好处在于在编译时就产生了类的字节码文件，可直接使用，效率上来讲还是很好的。</li>
<li>JDK动态代理必须实现<strong>接口</strong>，通过反射来动态代理方法，比较消耗系统性能。好处在于不用生成过多的代理类，避免编写大量的重复代码，比较灵活可用。</li>
<li>CGLIB动态代理<strong>无需实现接口</strong>，基于ASM的字节码生成库生成字节码来实现，比反射快一点，没有性能问题。缺点是犹豫CGLIB会继承被代理类，需要重写被代理的方法，所以被代理的类不能是final，被代理的方法也不能是final。</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://www.cnblogs.com/fillPv/p/5939277.html" target="_blank" rel="noopener">https://www.cnblogs.com/fillPv/p/5939277.html</a></li>
<li><a href="http://www.cnblogs.com/xiaoluo501395377/p/3383130.html" target="_blank" rel="noopener">http://www.cnblogs.com/xiaoluo501395377/p/3383130.html</a></li>
<li><a href="http://www.baeldung.com/java-asm" target="_blank" rel="noopener">http://www.baeldung.com/java-asm</a></li>
<li><a href="http://www.importnew.com/27772.html" target="_blank" rel="noopener">http://www.importnew.com/27772.html</a></li>
<li><a href="http://cxis.me/2017/04/12/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90/" target="_blank" rel="noopener">http://cxis.me/2017/04/12/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90/</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-proxy1/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/j-lo-proxy1/index.html</a></li>
<li><a href="https://www.zhihu.com/question/20794107" target="_blank" rel="noopener">https://www.zhihu.com/question/20794107</a></li>
</ul>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/06/12/Java-customize-annotation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/12/Java-customize-annotation/" itemprop="url">Java自定义注解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-12T16:43:02+08:00">
                2018-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>写这篇文章的背景是项目中需要一个测试方法执行时间的功能。主要有两种实现方式:</p>
<ul>
<li>在每个方法执行前后写入代码，这样冗余代码比较多，发布项目的话，还要去修改逻辑代码，不便于操作。</li>
<li>在第一种方案不可行的情况下，就思考到了结合AOP，来实现我们自定义的注解。</li>
</ul>
<h1 id="知识准备"><a href="#知识准备" class="headerlink" title="知识准备"></a>知识准备</h1><h2 id="interface"><a href="#interface" class="headerlink" title="@interface"></a>@interface</h2><p>在编写自定义的注解类之前，我们先要了解@interface，这是标识了一个注解类的主要元素，这里不再赘述。然后我们需要看看注解类上面的元注解</p>
<h2 id="Target"><a href="#Target" class="headerlink" title="@Target"></a>@Target</h2><p>该注解表明注解类能够作用的范围，也就是作用在哪个上面:类，方法，参数等等。</p>
<table>
<thead>
<tr>
<th>注解类型</th>
<th>作用范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Target(ElementType.TYPE)</td>
<td>接口、类、枚举、注解</td>
</tr>
<tr>
<td>@Target(ElementType.FIELD)</td>
<td>字段、枚举的常量</td>
</tr>
<tr>
<td>@Target(ElementType.METHOD)</td>
<td>方法</td>
</tr>
<tr>
<td>@Target(ElementType.PARAMETER)</td>
<td>方法参数</td>
</tr>
<tr>
<td>@Target(ElementType.CONSTRUCTOR)</td>
<td>构造函数</td>
</tr>
<tr>
<td>@Target(ElementType.LOCAL_VARIABLE)</td>
<td>局部变量</td>
</tr>
<tr>
<td>@Target(ElementType.LOCAL_VARIABLE)</td>
<td>局部变量</td>
</tr>
<tr>
<td>@Target(ElementType.ANNOTATION_TYPE)</td>
<td>注解</td>
</tr>
<tr>
<td>@Target(ElementType.PACKAGE)</td>
<td>包</td>
</tr>
</tbody>
</table>
<p>里面的参数都是可以多选的，使用:@Target({ElementType.METHOD,ElementType.FIELD})。</p>
<h2 id="Retention"><a href="#Retention" class="headerlink" title="@Retention"></a>@Retention</h2><p>@Retention可以设置注解的级别，分为三种，都有其特定的功能。</p>
<table>
<thead>
<tr>
<th>注解级别</th>
<th>存在范围</th>
<th>主要用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>SOURCE源码级别</td>
<td>注解只存在源码中</td>
<td>功能是与编译器交互，用于代码检测。如@Override,@SuppressWarings。额外效率损耗发生在编译时</td>
</tr>
<tr>
<td>CLASS 字节码级别</td>
<td>注解存在源码与字节码文件中</td>
<td>主要用于编译时生成额外的文件，如XML，Java文件等，但运行时无法获得。这个级别需要添加JVM加载时候的代理（javaagent），使用代理来动态修改字节码文件</td>
</tr>
<tr>
<td>RUNTIME 运行时级别</td>
<td>注解存在源码，字节码与Java虚拟机中</td>
<td>主要用于运行时反射获取相关信息</td>
</tr>
</tbody>
</table>
<h2 id="Documented"><a href="#Documented" class="headerlink" title="@Documented"></a>@Documented</h2><p>@Documented 注解表明这个注解应该被Javadoc工具记录，默认情况下，Javadoc是不包括注解的，但是如果声明注解时指定了@Documented，则它会被Javadoc之类的工具处理，所以注解类型信息也会被包括在生成的文档中。</p>
<h2 id="Order"><a href="#Order" class="headerlink" title="@Order"></a>@Order</h2><p>@Order注解定义了组件的加载顺序，这个注解包含一个value属性。属性接受整型值。值越小拥有越高的优先级。Ordered.HIGHEST_PRECEDENCE这个属性值是最高优先级的属性，它的值是-2147483648，对应的最低属性值是Ordered.LOWEST_PRECEDENCE，它的值是2147483647。</p>
<h1 id="开始撸代码"><a href="#开始撸代码" class="headerlink" title="开始撸代码"></a>开始撸代码</h1><h2 id="编写注解类"><a href="#编写注解类" class="headerlink" title="编写注解类"></a>编写注解类</h2><p><code>AnalysisTime.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.cruiser.support.annotation;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface AnalysisTime &#123;</span><br><span class="line"></span><br><span class="line">    int type() default 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="使用AOP进行切面编程"><a href="#使用AOP进行切面编程" class="headerlink" title="使用AOP进行切面编程"></a>使用AOP进行切面编程</h2><p>因为我是要将自定义Annotation集成在Springboot项目中，需要以下几个步骤。</p>
<h3 id="引入Maven"><a href="#引入Maven" class="headerlink" title="引入Maven"></a>引入Maven</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- AOP依赖模块 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="编写切面方法"><a href="#编写切面方法" class="headerlink" title="编写切面方法"></a>编写切面方法</h3><p><code>AnalysisTimeAspect.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.cruiser.support.annotation.aspect;</span><br><span class="line"></span><br><span class="line">import org.aspectj.lang.JoinPoint;</span><br><span class="line">import org.aspectj.lang.annotation.After;</span><br><span class="line">import org.aspectj.lang.annotation.Aspect;</span><br><span class="line">import org.aspectj.lang.annotation.Before;</span><br><span class="line">import org.aspectj.lang.annotation.Pointcut;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import com.jarvis.cruiser.support.annotation.AnalysisTime;</span><br><span class="line"></span><br><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class AnalysisTimeAspect &#123;</span><br><span class="line"></span><br><span class="line">	final static Logger logger = LoggerFactory.getLogger(AnalysisTimeAspect.class);</span><br><span class="line">	ThreadLocal&lt;Long&gt; beginTime = new ThreadLocal&lt;Long&gt;();</span><br><span class="line">	ThreadLocal&lt;Integer&gt; type = new ThreadLocal&lt;Integer&gt;();</span><br><span class="line">	ThreadLocal&lt;String&gt; methodName = new ThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">	@Pointcut(&quot;@annotation(analysisTime)&quot;)</span><br><span class="line">	public void timeStatistics(AnalysisTime analysisTime) &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Before(&quot;timeStatistics(analysisTime)&quot;)</span><br><span class="line">	public void doBefore(JoinPoint joinPoint, AnalysisTime analysisTime) &#123;</span><br><span class="line">		type.set(analysisTime.type());</span><br><span class="line">		methodName.set(joinPoint.getSignature().getDeclaringTypeName() + &quot; &quot; + joinPoint.getSignature().getName());</span><br><span class="line">		switch (type.get()) &#123;</span><br><span class="line">		case 0:</span><br><span class="line">			beginTime.set(System.currentTimeMillis());</span><br><span class="line">			break;</span><br><span class="line"></span><br><span class="line">		case 1:</span><br><span class="line">			beginTime.set(System.nanoTime());</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@After(&quot;timeStatistics(analysisTime)&quot;)</span><br><span class="line">	public void doAfter(AnalysisTime analysisTime) &#123;</span><br><span class="line">		long duration = 0L;</span><br><span class="line">		String unit = &quot;ms&quot;;</span><br><span class="line">		switch (type.get()) &#123;</span><br><span class="line">		case 0:</span><br><span class="line">			duration = System.currentTimeMillis() - beginTime.get();</span><br><span class="line">			break;</span><br><span class="line"></span><br><span class="line">		case 1:</span><br><span class="line">			duration = System.nanoTime() - beginTime.get();</span><br><span class="line">			unit = &quot;ns&quot;;</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">		logger.info(&quot;[AnalysisTime]excute [&#123;&#125;] method ,duration is:&#123;&#125;&quot; + unit, methodName.get(), duration);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用自定义Annotation"><a href="#使用自定义Annotation" class="headerlink" title="使用自定义Annotation"></a>使用自定义Annotation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/manage/ticket/list.dhtml&quot;)</span><br><span class="line">@AnalysisTime(type = 0)</span><br><span class="line">public String query(ModelMap model, HttpServletRequest request, Integer pageNo, ) &#123;</span><br><span class="line">    // 逻辑代码省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180612/1.png" alt="Alt text"></p>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>使用注解能够在某些特定场景下方便编程的开发，后续会加入一些高级的注解使用场景。</p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/06/05/SpringBoot-SpringSecurity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/05/SpringBoot-SpringSecurity/" itemprop="url">SpringBoot集成SpringSecurity</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-05T16:13:14+08:00">
                2018-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>SpringBoot作为微服务开发框架的便捷性不言而喻。通常，对于页面的安全控制也是必不可少的主要环节。本文主要采用Springboot+jpa+SpringSecurity+thymeleaf来进行页面的安全性控制。</p>
<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><ul>
<li><p>在<code>pom.xml</code>中添加配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">	&lt;!-- thymeleaf --&gt;</span><br><span class="line">	&lt;thymeleaf.version&gt;3.0.8.RELEASE&lt;/thymeleaf.version&gt;</span><br><span class="line">	&lt;thymeleaf-layout-dialect.version&gt;2.2.2&lt;/thymeleaf-layout-dialect.version&gt;</span><br><span class="line">	&lt;thymeleaf-extras-springsecurity4.version&gt;3.0.2.RELEASE&lt;/thymeleaf-extras-springsecurity4.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>pom.xml</code>中添加依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- SpringSecurity依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;thymeleaf-extras-springsecurity4&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这边注意好版本哦，有些低版本的话，thymeleaf中<code>sec:authorize=&quot;hasRole(&#39;ROLE_ADMIN&#39;)&quot;</code>标签会失效。</p>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h2><p>在用户表里增加一个字段<code>rolenames</code>，其主要作用是为了创建authorities权限列表，多个角色用分隔符<code>,</code>隔开，具体业务逻辑根据自己的需要去进行设计:<br><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180605/1.png" alt="Alt text"></p>
<h2 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h2><p>用户实体类需实现<code>UserDetails</code>接口，主要的权限控制方法是实现接口中的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">	return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>依照我上面的数据库设计，此处为了获取到用户的角色，具体实现为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">	List&lt;GrantedAuthority&gt; authorities = Lists.newArrayList();</span><br><span class="line">       // 切分方法可自己写，不一定用guava的split方法</span><br><span class="line">	List&lt;String&gt; roles = Splitter.on(CommonConstant.COMMON_COMMA_SPLITTER).trimResults().splitToList(this.rolenames);</span><br><span class="line">	for (String roleName : roles) &#123;</span><br><span class="line">		authorities.add(new SimpleGrantedAuthority(roleName));</span><br><span class="line">	&#125;</span><br><span class="line">	return authorities;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>User</code>实体完整代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.cruiser.model.acl;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import javax.persistence.Entity;</span><br><span class="line">import javax.persistence.GeneratedValue;</span><br><span class="line">import javax.persistence.Id;</span><br><span class="line"></span><br><span class="line">import org.springframework.security.core.GrantedAuthority;</span><br><span class="line">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line">import com.google.common.base.Splitter;</span><br><span class="line">import com.google.common.collect.Lists;</span><br><span class="line">import com.jarvis.cruiser.constant.CommonConstant;</span><br><span class="line">import com.jarvis.cruiser.model.BaseObject;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">public class User extends BaseObject implements UserDetails &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * </span><br><span class="line">	 */</span><br><span class="line">	private static final long serialVersionUID = -3757802379712748889L;</span><br><span class="line"></span><br><span class="line">	@Id</span><br><span class="line">	@GeneratedValue</span><br><span class="line">	private Long id;</span><br><span class="line">	private String username;</span><br><span class="line">	private String password;</span><br><span class="line">	private String rolenames;</span><br><span class="line"></span><br><span class="line">	public Long getId() &#123;</span><br><span class="line">		return id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setId(Long id) &#123;</span><br><span class="line">		this.id = id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getUsername() &#123;</span><br><span class="line">		return username;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setUsername(String username) &#123;</span><br><span class="line">		this.username = username;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getPassword() &#123;</span><br><span class="line">		return password;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setPassword(String password) &#123;</span><br><span class="line">		this.password = password;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Serializable realId() &#123;</span><br><span class="line">		return id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">		List&lt;GrantedAuthority&gt; authorities = Lists.newArrayList();</span><br><span class="line">		List&lt;String&gt; roles = Splitter.on(CommonConstant.COMMON_COMMA_SPLITTER).trimResults().splitToList(this.rolenames);</span><br><span class="line">		for (String roleName : roles) &#123;</span><br><span class="line">			authorities.add(new SimpleGrantedAuthority(roleName));</span><br><span class="line">		&#125;</span><br><span class="line">		return authorities;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean isAccountNonExpired() &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean isAccountNonLocked() &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean isCredentialsNonExpired() &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean isEnabled() &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getRolenames() &#123;</span><br><span class="line">		return rolenames;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setRolenames(String rolenames) &#123;</span><br><span class="line">		this.rolenames = rolenames;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h2><p>在需要的thymeleaf页面中额外添加头<code>&lt;html xmlns:sec=&quot;http://www.thymeleaf.org/extras/spring-security&quot;&gt;</code>，全部的格式为<code>&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot; xmlns:sec=&quot;http://www.thymeleaf.org/extras/spring-security&quot;&gt;</code>。<br>在需要控制的地方加上类似代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;li sec:authorize=&quot;hasRole(&apos;ROLE_ADMIN&apos;)&quot;&gt;&lt;a href=&quot;#&quot;&gt;&lt;i class=&quot;fa fa-table&quot;&gt;&lt;/i&gt; &lt;span class=&quot;nav-label&quot;&gt;数据管理&lt;/span&gt;&lt;span class=&quot;fa arrow&quot;&gt;&lt;/span&gt;&lt;/a&gt;</span><br><span class="line">    &lt;ul class=&quot;nav nav-second-level&quot;&gt;</span><br><span class="line">        &lt;li&gt;&lt;a class=&quot;J_menuItem&quot; th:href=&quot;@&#123;/manage/ticket/import.dhtml&#125;&quot;&gt;导入数据&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;&lt;a class=&quot;J_menuItem&quot; th:href=&quot;@&#123;/manage/ticket/list.dhtml&#125;&quot;&gt;查询数据&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure></p>
<p>这边的<code>sec:authorize=&quot;hasRole(&#39;ROLE_ADMIN&#39;)&quot;</code>意思是，具有<code>ROLE_ADMIN</code>角色的用户才能显示此标签列表。具体更多的标签参照文档:<a href="https://github.com/thymeleaf/thymeleaf-extras-springsecurity" target="_blank" rel="noopener">thymeleaf-extras-springsecurity</a></p>
<h2 id="Step-4"><a href="#Step-4" class="headerlink" title="Step 4"></a>Step 4</h2><p>上面只是完成简单的根据角色显示，SpringSecurity最核心的对url拦截还未进行，那我们开始吧。权限管理主要分为两个部分:</p>
<ul>
<li><p>登录验证 <code>AuthenticationProcessingFilter</code></p>
<ul>
<li>登录验证比较简单，主要会被<code>AuthenticationProcessingFilter</code>拦截，调用<code>AuthenticationManager</code>来实现，Springboot封装了一系列复杂的操作，直接实现<code>UserDetailsService</code>接口:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException &#123;</span><br><span class="line">    User user = userRepository.findByUsername(s);</span><br><span class="line">    if (user == null) throw new UsernameNotFoundException(&quot;用户名不存在&quot;);</span><br><span class="line"></span><br><span class="line">    return new org.springframework.security.core.userdetails.User(user.getUsername(), user.getPassword(), user.getAuthorities());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>访问资源管理 <code>AbstractSecurityInterceptor</code>，这里需要<code>AuthenticationManager</code>、<code>accessDecisionManager</code>来支撑整个验证流程。</p>
<ul>
<li>访问url时，会通过<code>AbstractSecurityInterceptor</code>拦截器拦截，其中会调用<code>FilterInvocationSecurityMetadataSource</code>的方法来获取被拦截url所需的全部权限，再调用授权管理器<code>AccessDecisionManager</code>，这个管理器会通过spring的全局缓存<code>SecurityContextHolder</code>获取用户的权限信息，还会获得被拦截的url和被拦截url所需的全部权限，然后根据所配的策略（有：一票决定，一票否定，少数服从多数等），如果权限足够，则返回，权限不够则报错并调用权限不足页面。</li>
</ul>
</li>
</ul>
<p><code>MyAccessDecisionManager.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.cruiser.service.acl;</span><br><span class="line"></span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.Iterator;</span><br><span class="line"></span><br><span class="line">import org.springframework.security.access.AccessDecisionManager;</span><br><span class="line">import org.springframework.security.access.AccessDeniedException;</span><br><span class="line">import org.springframework.security.access.ConfigAttribute;</span><br><span class="line">import org.springframework.security.authentication.InsufficientAuthenticationException;</span><br><span class="line">import org.springframework.security.core.Authentication;</span><br><span class="line">import org.springframework.security.core.GrantedAuthority;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class MyAccessDecisionManager implements AccessDecisionManager &#123;</span><br><span class="line"></span><br><span class="line">	// decide方法是判定是否拥有权限的决策方法</span><br><span class="line">	// authentication是UserService中循环添加到GrantedAuthority对象中的权限信息集合</span><br><span class="line">	// object 包含客户端发起的请求的request的信息，可转换为HttpServletRequest request=((FilterInvocation)object).getHttpRequest();</span><br><span class="line">	// configAttributes 为MyAccessDecisionSecurityMetadataSource的getAttributes(Object object)这个方法返回的结果，此方法是为了判定用户请求的url 是否在权限表中，如果在权限表中，则返回给 decide 方法，用来判定用户是否有此权限。如果不在权限表中则放行。</span><br><span class="line">	@Override</span><br><span class="line">	public void decide(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; configAttributes) throws AccessDeniedException, InsufficientAuthenticationException &#123;</span><br><span class="line"></span><br><span class="line">		if (null == configAttributes || configAttributes.size() &lt;= 0) return;</span><br><span class="line">		ConfigAttribute configAttribute;</span><br><span class="line">		String needRole;</span><br><span class="line">		for (Iterator&lt;ConfigAttribute&gt; iterator = configAttributes.iterator(); iterator.hasNext();) &#123;</span><br><span class="line">			configAttribute = iterator.next();</span><br><span class="line">			needRole = configAttribute.getAttribute();</span><br><span class="line">			// authentication 为在注释1 中循环添加到 GrantedAuthority 对象中的权限信息集合</span><br><span class="line">			for (GrantedAuthority ga : authentication.getAuthorities()) &#123;</span><br><span class="line">				if (needRole.trim().equals(ga.getAuthority())) return;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		throw new AccessDeniedException(&quot;no right&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean supports(ConfigAttribute attribute) &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean supports(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>MyFilterSecurityInterceptor.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.cruiser.service.acl;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">import javax.servlet.Filter;</span><br><span class="line">import javax.servlet.FilterChain;</span><br><span class="line">import javax.servlet.FilterConfig;</span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.ServletRequest;</span><br><span class="line">import javax.servlet.ServletResponse;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.security.access.SecurityMetadataSource;</span><br><span class="line">import org.springframework.security.access.intercept.AbstractSecurityInterceptor;</span><br><span class="line">import org.springframework.security.access.intercept.InterceptorStatusToken;</span><br><span class="line">import org.springframework.security.web.FilterInvocation;</span><br><span class="line">import org.springframework.security.web.access.intercept.FilterInvocationSecurityMetadataSource;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class MyFilterSecurityInterceptor extends AbstractSecurityInterceptor implements Filter &#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private FilterInvocationSecurityMetadataSource securityMetadataSource;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	public void serMyAccessDecisionManager(MyAccessDecisionManager myAccessDecisionManager) &#123;</span><br><span class="line">		super.setAccessDecisionManager(myAccessDecisionManager);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void destroy() &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123;</span><br><span class="line">		FilterInvocation filterInvocation = new FilterInvocation(request, response, chain);</span><br><span class="line">		invoke(filterInvocation);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void invoke(FilterInvocation filterInvocation) throws IOException, ServletException &#123;</span><br><span class="line">		// filterInvocation里面有一个被拦截的url</span><br><span class="line">		// 里面调用MyInvocationSecurityMetadataSource的getAttributes(Object object)这个方法获取filterInvocation对应的所有权限</span><br><span class="line">		// 再调用MyAccessDecisionManager的decide方法来校验用户的权限是否足够</span><br><span class="line">		InterceptorStatusToken token = super.beforeInvocation(filterInvocation);</span><br><span class="line">		try &#123;</span><br><span class="line">			// 执行下一个拦截器</span><br><span class="line">			filterInvocation.getChain().doFilter(filterInvocation.getRequest(), filterInvocation.getResponse());</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			super.afterInvocation(token, null);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Class&lt;?&gt; getSecureObjectClass() &#123;</span><br><span class="line">		return FilterInvocation.class;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public SecurityMetadataSource obtainSecurityMetadataSource() &#123;</span><br><span class="line">		return this.securityMetadataSource;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>MyInvocationSecurityMetadataSourceService.java</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.cruiser.service.acl;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Iterator;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.security.access.ConfigAttribute;</span><br><span class="line">import org.springframework.security.access.SecurityConfig;</span><br><span class="line">import org.springframework.security.web.FilterInvocation;</span><br><span class="line">import org.springframework.security.web.access.intercept.FilterInvocationSecurityMetadataSource;</span><br><span class="line">import org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import com.jarvis.cruiser.dao.repository.PermissionRepository;</span><br><span class="line">import com.jarvis.cruiser.model.acl.SysPermission;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class MyInvocationSecurityMetadataSourceService implements FilterInvocationSecurityMetadataSource &#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private PermissionRepository permissionRepository;</span><br><span class="line">	private HashMap&lt;String, Collection&lt;ConfigAttribute&gt;&gt; map = null;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 加载权限表中所有权限</span><br><span class="line">	 */</span><br><span class="line">	public void loadResourceDefine() &#123;</span><br><span class="line">		map = new HashMap&lt;String, Collection&lt;ConfigAttribute&gt;&gt;();</span><br><span class="line">		List&lt;SysPermission&gt; permissions = permissionRepository.findAll();</span><br><span class="line">		for (SysPermission sysPermission : permissions) &#123;</span><br><span class="line">			map.put(sysPermission.getUrl(), SecurityConfig.createList(StringUtils.split(sysPermission.getName(), &quot;,&quot;)));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Collection&lt;ConfigAttribute&gt; getAttributes(Object object) throws IllegalArgumentException &#123;</span><br><span class="line">		if (map == null) loadResourceDefine();</span><br><span class="line">		// object 中包含用户请求的request 信息</span><br><span class="line">		HttpServletRequest request = ((FilterInvocation) object).getHttpRequest();</span><br><span class="line">		AntPathRequestMatcher matcher;</span><br><span class="line">		String resUrl;</span><br><span class="line">		for (Iterator&lt;String&gt; iter = map.keySet().iterator(); iter.hasNext();) &#123;</span><br><span class="line">			resUrl = iter.next();</span><br><span class="line">			matcher = new AntPathRequestMatcher(resUrl);</span><br><span class="line">			if (matcher.matches(request)) &#123;</span><br><span class="line">				return map.get(resUrl);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return null;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() &#123;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean supports(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>权限<code>permission</code>表：<br><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180605/2.png" alt="Alt text"></p>
<h2 id="Step-5"><a href="#Step-5" class="headerlink" title="Step 5"></a>Step 5</h2><p>最后一步，添加Springboot配置文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">package com.jarvis.cruiser.config;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import org.springframework.security.web.csrf.CsrfFilter;</span><br><span class="line">import org.springframework.web.filter.CharacterEncodingFilter;</span><br><span class="line"></span><br><span class="line">import com.jarvis.cruiser.service.acl.UserService;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSecurity</span><br><span class="line">public class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	UserDetailsService userService() &#123;</span><br><span class="line">		return new UserService();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">		http.authorizeRequests().antMatchers(&quot;/css/**&quot;, &quot;/js/**&quot;, &quot;/images/**&quot;, &quot;/plugins/**&quot;, &quot;/fonts/**&quot;).permitAll().anyRequest().authenticated().and().formLogin().loginPage(&quot;/login&quot;).failureUrl(&quot;/login?error&quot;).permitAll().and().headers().frameOptions().disable().and().logout().logoutUrl(&quot;/logout&quot;)</span><br><span class="line">				.logoutSuccessUrl(&quot;/login&quot;).permitAll();</span><br><span class="line">		// 解决非thmeleaf的form表单提交被拦截问题</span><br><span class="line">		http.csrf().disable();</span><br><span class="line"></span><br><span class="line">		// 解决中文乱码问题</span><br><span class="line">		CharacterEncodingFilter filter = new CharacterEncodingFilter();</span><br><span class="line">		filter.setEncoding(&quot;UTF-8&quot;);</span><br><span class="line">		filter.setForceEncoding(true);</span><br><span class="line">		http.addFilterBefore(filter, CsrfFilter.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line">		auth.userDetailsService(userService()).passwordEncoder(new org.springframework.security.crypto.password.PasswordEncoder() &#123;</span><br><span class="line"></span><br><span class="line">			@Override</span><br><span class="line">			public boolean matches(CharSequence rawPassword, String encodedPassword) &#123;</span><br><span class="line">				return StringUtils.equals(DigestUtils.md5Hex((String) rawPassword), encodedPassword);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			@Override</span><br><span class="line">			public String encode(CharSequence rawPassword) &#123;</span><br><span class="line">				return DigestUtils.md5Hex((String) rawPassword);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Step-6"><a href="#Step-6" class="headerlink" title="Step 6"></a>Step 6</h2><p>运行项目，依次去验证上述添加的功能。</p>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>本篇没有详细的讲到SpringSecurity的内部运行机制，后续有时间的话，会从源码的角度去分析Spring Security。</p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/06/04/SpringBoot-dockerfile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/04/SpringBoot-dockerfile/" itemprop="url">SpringBoot-构建docker镜像</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-04T16:27:01+08:00">
                2018-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>Docker的出现使得以Springboot为基础的微服务项目部署如此简单。</p>
<h1 id="添加Docker依赖"><a href="#添加Docker依赖" class="headerlink" title="添加Docker依赖"></a>添加Docker依赖</h1><p>在Springboot项目中的<code>pom.xml</code>文件中添加相关属性，供插件使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;docker.image.prefix&gt;jarvis&lt;/docker.image.prefix&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>
<p>原来的Maven打包插件为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;mainClass&gt;$&#123;start-class&#125;&lt;/mainClass&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">            &lt;executions&gt;</span><br><span class="line">                &lt;execution&gt;</span><br><span class="line">                    &lt;goals&gt;</span><br><span class="line">                        &lt;goal&gt;repackage&lt;/goal&gt;</span><br><span class="line">                    &lt;/goals&gt;</span><br><span class="line">                &lt;/execution&gt;</span><br><span class="line">            &lt;/executions&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p>添加Docker构建插件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line"></span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;com.spotify&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;imageName&gt;$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;&lt;/imageName&gt;</span><br><span class="line">                &lt;dockerDirectory&gt;src/main/docker&lt;/dockerDirectory&gt;</span><br><span class="line">                &lt;resources&gt;</span><br><span class="line">                    &lt;resource&gt;</span><br><span class="line">                        &lt;targetPath&gt;/&lt;/targetPath&gt;</span><br><span class="line">                        &lt;directory&gt;$&#123;project.build.directory&#125;&lt;/directory&gt;</span><br><span class="line">                        &lt;include&gt;$&#123;project.build.finalName&#125;.jar&lt;/include&gt;</span><br><span class="line">                    &lt;/resource&gt;</span><br><span class="line">                &lt;/resources&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p>这边需要解释这边docker插件的参数含义:</p>
<ul>
<li>imageName: <code>${docker.image.prefix}</code>为之前设定的前缀即<code>jarvis</code>，可以自定义自己的专属名称;<code>${project.artifactId}</code>为项目的<code>artifactId</code>，这边不用专门设置<code>properties</code>即可获得。</li>
<li>dockerDirectory:获取Dockerfile的地址，这个Dockerfile文件是用来说明如何构建镜像。</li>
</ul>
<h1 id="编写Dockerfile文件"><a href="#编写Dockerfile文件" class="headerlink" title="编写Dockerfile文件"></a>编写Dockerfile文件</h1><p>在目录<code>src/main/docker</code>下创建Dockerfile文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8-jdk-alpine</span><br><span class="line">VOLUME /tmp</span><br><span class="line">ADD cruiser-0.0.1-SNAPSHOT.jar cruiser.jar</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd=file:/dev/./urandom&quot;,&quot;-jar&quot;,&quot;/cruiser.jar&quot;]</span><br></pre></td></tr></table></figure>
<p>这个是个比较简单的Dockerfile文件:</p>
<ul>
<li>FROM 使用jdk8为基础镜像，如果不是本地镜像将会从dockerhub上进行下载。</li>
<li>VOLUME Springboot中使用了内置的tomcat容器，而tomcat默认使用了<code>/tmp</code>作为工作目录，上述的命令是在宿主机的/var/lib/docker目录下创建一个临时文件并链接到容器的/tmp目录。</li>
<li>ADD 拷贝编译好的jar文件并重命名</li>
<li>ENTRYPOINT 为了缩短Tomcat的启动时间，添加<code>java.security.egd</code>的系统属性指向<code>/dev/./urandom</code>作为ENTRYPOINT</li>
</ul>
<h1 id="打包环境"><a href="#打包环境" class="headerlink" title="打包环境"></a>打包环境</h1><ul>
<li>安装Docker环境（安装方法自行谷歌）</li>
<li>安装Jdk（安装方法自行谷歌）</li>
<li>安装Maven（安装方法自行谷歌）</li>
</ul>
<h1 id="开始打包"><a href="#开始打包" class="headerlink" title="开始打包"></a>开始打包</h1><p>进入打包步骤的前提是打包环境要安装好哦。</p>
<h2 id="step-1"><a href="#step-1" class="headerlink" title="step 1"></a>step 1</h2><p>将项目拷贝到服务器中(可以使用rz,sz工具)，当然后续可以使用jenkins，webhook之类的技术直接从git拉代码构建，此处不做叙述。</p>
<h2 id="step-2"><a href="#step-2" class="headerlink" title="step 2"></a>step 2</h2><p>使用 <code>mvn package docker:build</code>命令来使用Dockerfile构建镜像。第一次构建会有点慢，会在控制台看见输出如下图：<br><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180604/1.png" alt="Alt text"></p>
<h2 id="step-3"><a href="#step-3" class="headerlink" title="step 3"></a>step 3</h2><p>使用<code>docker images</code>命令查看构建好的镜像，如下图：<br><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180604/2.png" alt="Alt text"></p>
<h1 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h1><ul>
<li>使用命令<code>docker run -p [localport]:[port] -t jarvis/cruiser</code>:<br><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180604/3.png" alt="Alt text"></li>
<li>可以使用<code>docker ps</code>命令查看当前正在运行的镜像，就可以看到我们刚刚启动的啦。</li>
<li>在浏览器中输入项目的地址，即可访问项目:<code>http://ip:port</code>。</li>
</ul>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/03/07/Leetcode-22-Generate-Parentheses/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/07/Leetcode-22-Generate-Parentheses/" itemprop="url">Leetcode#22 Generate Parentheses</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-07T13:45:25+08:00">
                2018-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Generate-Parentheses"><a href="#Generate-Parentheses" class="headerlink" title="Generate Parentheses"></a>Generate Parentheses</h1><blockquote>
<p>Given n pairs of parentheses, write a function to generate all combinations of well-formed parentheses.<br>For example, given n = 3, a solution set is:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &quot;((()))&quot;,</span><br><span class="line">  &quot;(()())&quot;,</span><br><span class="line">  &quot;(())()&quot;,</span><br><span class="line">  &quot;()(())&quot;,</span><br><span class="line">  &quot;()()()&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="题目翻译"><a href="#题目翻译" class="headerlink" title="题目翻译"></a>题目翻译</h2><blockquote>
<p>给定n对括号，写一个方法生成所有正确组合的括号对。</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><h3 id="思路一-回溯法"><a href="#思路一-回溯法" class="headerlink" title="思路一 回溯法"></a>思路一 回溯法</h3><h4 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h4><p>时间复杂度:O(n)，空间复杂度:O(n)。</p>
<h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>根据题意，我们防止n个左括号，放置一个，剩余放置的左括号就少一个，但是剩余可放置的右括号就多一个。而对于右括号，前面必须放置一个左括号，我们才能放置一个右括号。所以根据剩余可放置的左括号，和剩余可放置的右括号代入递归。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line"></span><br><span class="line">	List&lt;String&gt; result = new LinkedList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">	public List&lt;String&gt; generateParenthesis(int n) &#123;</span><br><span class="line">		helper(n, 0, &quot;&quot;);</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private void helper(int left, int right, String tmp) &#123;</span><br><span class="line">		// 如果左括号和右括号都放完了，则找到一个结果。</span><br><span class="line">		if (left == 0 &amp;&amp; right == 0) &#123;</span><br><span class="line">			result.add(tmp);</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">		// 对于每个位置，我们有两种选择，要么放左括号，要么放右括号。</span><br><span class="line">		if (left &gt; 0) &#123;</span><br><span class="line">			helper(left - 1, right + 1, tmp + &quot;(&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (right &gt; 0) &#123;</span><br><span class="line">			helper(left, right - 1, tmp + &quot;)&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/03/05/Leetcode-21-Merge-Two-Sorted-Lists/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/05/Leetcode-21-Merge-Two-Sorted-Lists/" itemprop="url">Leetcode#21 Merge Two Sorted Lists</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-05T14:01:07+08:00">
                2018-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Merge-Two-Sorted-Lists"><a href="#Merge-Two-Sorted-Lists" class="headerlink" title="Merge Two Sorted Lists"></a>Merge Two Sorted Lists</h1><blockquote>
<p>Merge two sorted linked lists and return it as a new list. The new list should be made by splicing together the nodes of the first two lists.<br>Example<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: 1-&gt;2-&gt;4, 1-&gt;3-&gt;4</span><br><span class="line">Output: 1-&gt;1-&gt;2-&gt;3-&gt;4-&gt;4</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="题目翻译"><a href="#题目翻译" class="headerlink" title="题目翻译"></a>题目翻译</h2><blockquote>
<p>合并两个排好序的链表，并返回新链表。新链表应由两个链表的头部拼接而成。</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><h3 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h3><h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>首先进行边界条件的判断，如果其中任意一个表是空表，就返回另外一个表。然后使用递归的方法进行两个链表节点的比较。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line"></span><br><span class="line">	public ListNode mergeTwoLists(ListNode l1, ListNode l2) &#123;</span><br><span class="line">		if (l1 == null) return l2;</span><br><span class="line">		if (l2 == null) return l1;</span><br><span class="line">		if (l1.val &lt; l2.val) &#123;</span><br><span class="line">			l1.next = mergeTwoLists(l1.next, l2);</span><br><span class="line">			return l1;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			l2.next = mergeTwoLists(l1, l2.next);</span><br><span class="line">			return l2;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public class ListNode &#123;</span><br><span class="line">		int val;</span><br><span class="line">		ListNode next;</span><br><span class="line"></span><br><span class="line">		ListNode(int x) &#123;</span><br><span class="line">			val = x;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/03/05/Leetcode-20-Valid-Parentheses/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/05/Leetcode-20-Valid-Parentheses/" itemprop="url">Leetcode#20 Valid Parentheses</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-05T13:26:37+08:00">
                2018-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Valid-Parentheses"><a href="#Valid-Parentheses" class="headerlink" title="Valid Parentheses"></a>Valid Parentheses</h1><blockquote>
<p>Given a string containing just the characters ‘(‘, ‘)’, ‘{‘, ‘}’, ‘[‘ and ‘]’, determine if the input string is valid.<br>The brackets must close in the correct order, “()” and “()[]{}” are all valid but “(]” and “([)]” are not.</p>
</blockquote>
<h2 id="题目翻译"><a href="#题目翻译" class="headerlink" title="题目翻译"></a>题目翻译</h2><blockquote>
<p>给定一个只包含’(‘, ‘)’, ‘{‘, ‘}’, ‘[‘和 ‘]’的字符串，确定给定的字符串是否有效。括号的闭合是按照正确的顺序，例：”()” 和 “()[]{}”是有效的，但是”(]” 和 “([)]”是无效的。</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><h3 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h3><h4 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h4><p>时间复杂度O(n)</p>
<h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>左符号入栈，右符号出栈，最后检查栈是否为空。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public boolean isValid(String s) &#123;</span><br><span class="line">	if (s == null || s.length() &lt; 2) return false;</span><br><span class="line"></span><br><span class="line">	Stack&lt;Character&gt; stack = new Stack&lt;Character&gt;();</span><br><span class="line">	for (char c : s.toCharArray()) &#123;</span><br><span class="line">		if (c == &apos;(&apos;) stack.push(&apos;)&apos;);</span><br><span class="line">		else if (c == &apos;&#123;&apos;) stack.push(&apos;&#125;&apos;);</span><br><span class="line">		else if (c == &apos;[&apos;) stack.push(&apos;]&apos;);</span><br><span class="line">		else if (stack.isEmpty() || stack.pop() != c) return false;</span><br><span class="line">	&#125;</span><br><span class="line">	return stack.isEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/03/05/Leetcode-19-Remove-Nth-Node-From-End-of-List/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/05/Leetcode-19-Remove-Nth-Node-From-End-of-List/" itemprop="url">Leetcode#19 Remove Nth Node From End of List</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-05T11:15:06+08:00">
                2018-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Remove-Nth-Node-From-End-of-List"><a href="#Remove-Nth-Node-From-End-of-List" class="headerlink" title="Remove Nth Node From End of List"></a>Remove Nth Node From End of List</h1><blockquote>
<p>Given a linked list, remove the nth node from the end of list and return its head.<br>For example,</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Given linked list: 1-&gt;2-&gt;3-&gt;4-&gt;5, and n = 2.</span><br><span class="line">After removing the second node from the end, the linked list becomes 1-&gt;2-&gt;3-&gt;5.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note:<br>Given n will always be valid.<br>Try to do this in one pass.</p>
</blockquote>
<h2 id="题目翻译"><a href="#题目翻译" class="headerlink" title="题目翻译"></a>题目翻译</h2><blockquote>
<p>给定一个指针链表，删除其倒数第N个元素。</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><h3 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h3><h4 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h4><p>时间复杂度：O(L)，空间复杂度为O(1)。<br>这个算法进行了两次链表的遍历。第一次遍历计算了链表的长度L，第二次遍历是为了找到第(L-n)个节点。总共进行了(2L-n)次操作，所以时间复杂度为O(L).</p>
<h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>问题可以简化成：移除链表的第(L-n+1)个节点，其中L为链表的长度。当我们知道链表的长度L时，问题就迎刃而解了。<br>首先在链表的头部增加一个虚拟的节点。这个节点用来简化一些边缘情况的处理，比如链表只有一个节点，或者移除链表的头部。第一步，我们找到链表长度L。然后我们设置一个指针指向虚拟的节点并且开始移动直至第(L-n)个节点。此时重新使得第(L-n)个节点的next指针指向第(L-n+2)个节点，问题得解。</p>
<p><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180305/19_Remove_nth_node_from_end_of_listA.png" alt="Alt text"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line"></span><br><span class="line">	public ListNode removeNthFromEnd(ListNode head, int n) &#123;</span><br><span class="line">		ListNode dummy = new ListNode(0);</span><br><span class="line">		dummy.next = head;</span><br><span class="line">		int length = 0;</span><br><span class="line">		ListNode first = head;</span><br><span class="line">		while (first != null) &#123;</span><br><span class="line">			length++;</span><br><span class="line">			first = first.next;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		length -= n;</span><br><span class="line">		first = dummy;</span><br><span class="line">		while (length &gt; 0) &#123;</span><br><span class="line">			length--;</span><br><span class="line">			first = first.next;</span><br><span class="line">		&#125;</span><br><span class="line">		first.next = first.next.next;</span><br><span class="line">		return dummy.next;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public class ListNode &#123;</span><br><span class="line">		int val;</span><br><span class="line">		ListNode next;</span><br><span class="line"></span><br><span class="line">		ListNode(int x) &#123;</span><br><span class="line">			val = x;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="思路二"><a href="#思路二" class="headerlink" title="思路二"></a>思路二</h3><h4 id="复杂度-1"><a href="#复杂度-1" class="headerlink" title="复杂度"></a>复杂度</h4><p>时间复杂度:O(L)，空间复杂度:O(1)。此算法只遍历了一次链表的L个节点，因此时间复杂度为O(L)。</p>
<h4 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h4><p>上述方法可以只需要进行一次遍历就可完成相同功能。我们用两个指针来解决这个问题。第一个指针相较于第二个指针先走n+1步，通俗的来讲，先讲first、second指针之间的间距为n。然后同时移动指针直到first指针移动到最后一个节点。然后进行与方法一相同的思路操作。</p>
<p><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180305/19_Remove_nth_node_from_end_of_listB.png" alt="Alt text"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class Solution2 &#123;</span><br><span class="line"></span><br><span class="line">	public ListNode removeNthFromEnd(ListNode head, int n) &#123;</span><br><span class="line">		ListNode dummy = new Solution().new ListNode(0);</span><br><span class="line">		dummy.next = head;</span><br><span class="line">		ListNode first = dummy;</span><br><span class="line">		ListNode second = dummy;</span><br><span class="line"></span><br><span class="line">		// 先让first先跑与second节点间有n个节点的距离</span><br><span class="line">		for (int i = 1; i &lt;= n + 1; i++) &#123;</span><br><span class="line">			first = first.next;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// 移动first到最后</span><br><span class="line">		while (first != null) &#123;</span><br><span class="line">			first = first.next;</span><br><span class="line">			second = second.next;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		second.next = second.next.next;</span><br><span class="line">		return dummy.next;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/03/01/Leetcode-18-4Sum/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/01/Leetcode-18-4Sum/" itemprop="url">Leetcode#18 4Sum</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-01T16:47:40+08:00">
                2018-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="4Sum"><a href="#4Sum" class="headerlink" title="4Sum"></a>4Sum</h1><blockquote>
<p>Given an array S of n integers, are there elements a, b, c, and d in S such that a + b + c + d = target? Find all unique quadruplets in the array which gives the sum of target.</p>
<p>Note: The solution set must not contain duplicate quadruplets.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">For example, given array S = [1, 0, -1, 0, -2, 2], and target = 0.</span><br><span class="line"></span><br><span class="line">A solution set is:</span><br><span class="line">[</span><br><span class="line">  [-1,  0, 0, 1],</span><br><span class="line">  [-2, -1, 1, 2],</span><br><span class="line">  [-2,  0, 0, 2]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="题目翻译"><a href="#题目翻译" class="headerlink" title="题目翻译"></a>题目翻译</h2><blockquote>
<p>给定一个包含n个数的整数数组S，在S中找到所有是的和为给定整数target的四元组(a,b,c,d)。</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><h3 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h3><h4 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h4><p>时间复杂度:O(n^3)</p>
<h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>最基本的思想就是用3Sum和2Sum的子函数，摒弃所有不可能的结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line">	public List&lt;List&lt;Integer&gt;&gt; fourSum(int[] nums, int target) &#123;</span><br><span class="line">		List&lt;List&lt;Integer&gt;&gt; result = new ArrayList&lt;List&lt;Integer&gt;&gt;();</span><br><span class="line">		int len = nums.length;</span><br><span class="line">		if (nums == null || len &lt; 4) return result;</span><br><span class="line"></span><br><span class="line">		Arrays.sort(nums);</span><br><span class="line"></span><br><span class="line">		int max = nums[len - 1];</span><br><span class="line">		if (4 * nums[0] &gt; target || 4 * max &lt; target) return result;</span><br><span class="line"></span><br><span class="line">		int i, z;</span><br><span class="line">		for (i = 0; i &lt; len; i++) &#123;</span><br><span class="line">			z = nums[i];</span><br><span class="line">			if (i &gt; 0 &amp;&amp; z == nums[i - 1]) // 避免重复</span><br><span class="line">				continue;</span><br><span class="line">			if (z + 3 * max &lt; target) // z太小</span><br><span class="line">				continue;</span><br><span class="line">			if (4 * z &gt; target) // z太大</span><br><span class="line">				break;</span><br><span class="line">			if (4 * z == target) &#123; // z是边界</span><br><span class="line">				if (i + 3 &lt; len &amp;&amp; nums[i + 3] == z) &#123;</span><br><span class="line">					result.add(Arrays.asList(z, z, z, z));</span><br><span class="line">				&#125;</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			threeSumForFourSum(nums, target - z, i + 1, len - 1, result, z);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void threeSumForFourSum(int[] nums, int target, int low, int high, List&lt;List&lt;Integer&gt;&gt; fourSumList, int z1) &#123;</span><br><span class="line">		if (low + 1 &gt;= high) return;</span><br><span class="line">		int max = nums[high];</span><br><span class="line">		if (3 * nums[low] &gt; target || 3 * max &lt; target) return;</span><br><span class="line"></span><br><span class="line">		int i, z;</span><br><span class="line">		for (i = low; i &lt; high - 1; i++) &#123;</span><br><span class="line">			z = nums[i];</span><br><span class="line">			if (i &gt; low &amp;&amp; z == nums[i - 1]) // 避免重复</span><br><span class="line">				continue;</span><br><span class="line"></span><br><span class="line">			if (z + 2 * max &lt; target) continue; // z太小</span><br><span class="line">			if (3 * z == target) // z太大</span><br><span class="line">				break;</span><br><span class="line">			if (3 * z == target) &#123;</span><br><span class="line">				if (i + 1 &lt; high &amp;&amp; nums[i + 2] == z) &#123;</span><br><span class="line">					fourSumList.add(Arrays.asList(z1, z, z, z));</span><br><span class="line">				&#125;</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			twoSumForFourSum(nums, target - z, i + 1, high, fourSumList, z1, z);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void twoSumForFourSum(int[] nums, int target, int low, int high, List&lt;List&lt;Integer&gt;&gt; fourSumList, int z1, int z2) &#123;</span><br><span class="line">		if (low &gt;= high) return;</span><br><span class="line">		if (2 * nums[low] &gt; target || 2 * nums[high] &lt; target) return;</span><br><span class="line"></span><br><span class="line">		int i = low, j = high, sum, x;</span><br><span class="line">		while (i &lt; j) &#123;</span><br><span class="line">			sum = nums[i] + nums[j];</span><br><span class="line">			if (sum == target) &#123;</span><br><span class="line">				fourSumList.add(Arrays.asList(z1, z2, nums[i], nums[j]));</span><br><span class="line"></span><br><span class="line">				x = nums[i];</span><br><span class="line">				while (++i &lt; j &amp;&amp; x == nums[i]) // 避免重复</span><br><span class="line">					;</span><br><span class="line">				x = nums[j];</span><br><span class="line">				while (i &lt; --j &amp;&amp; x == nums[j])// 避免重复</span><br><span class="line">					;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			if (sum &lt; target) i++;</span><br><span class="line">			if (sum &gt; target) j--;</span><br><span class="line">		&#125;</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://smarticeberg.github.io/2018/03/01/Leetcode-17-Letter-Combinations-of-a-Phone-Number/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Iceberg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jarvis的技术小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/01/Leetcode-17-Letter-Combinations-of-a-Phone-Number/" itemprop="url">Leetcode#17 Letter Combinations of a Phone Number</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-01T13:44:08+08:00">
                2018-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Letter-Combinations-of-a-Phone-Number"><a href="#Letter-Combinations-of-a-Phone-Number" class="headerlink" title="Letter Combinations of a Phone Number"></a>Letter Combinations of a Phone Number</h1><blockquote>
<p>Given a digit string, return all possible letter combinations that the number could represent.A mapping of digit to letters (just like on the telephone buttons) is given below.</p>
</blockquote>
<p><img src="http://p1cwch5gs.bkt.clouddn.com/images/blog/20180301/200px-Telephone-keypad2.svg.png" alt="Alt text"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input:Digit string &quot;23&quot;</span><br><span class="line">Output: [&quot;ad&quot;, &quot;ae&quot;, &quot;af&quot;, &quot;bd&quot;, &quot;be&quot;, &quot;bf&quot;, &quot;cd&quot;, &quot;ce&quot;, &quot;cf&quot;].</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note:<br>Although the above answer is in lexicographical order, your answer could be in any order you want.</p>
</blockquote>
<h2 id="题目翻译"><a href="#题目翻译" class="headerlink" title="题目翻译"></a>题目翻译</h2><blockquote>
<p>给定一个数字字符串，找出这个字符串在九宫格键盘上对应字母的所有组合。</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><h3 id="思路一-深度优先搜索"><a href="#思路一-深度优先搜索" class="headerlink" title="思路一  深度优先搜索"></a>思路一  深度优先搜索</h3><h4 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h4><p>时间 O(n) 空间 O(n)</p>
<h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>首先建立号码与字母的映射表，然后对号码进行深度优先搜索，对于每一位，找出数字对应的字母，这些字母就是本轮搜索的几种可能。需要注意的一点是，当临时字符串为空的时候，不用将其加入结果列表中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line">	private List&lt;String&gt; result;</span><br><span class="line"></span><br><span class="line">	public List&lt;String&gt; letterCombinations(String digits) &#123;</span><br><span class="line">		// 建立对应的映射表</span><br><span class="line">		String[] table = &#123; &quot;&quot;, &quot;&quot;, &quot;abc&quot;, &quot;def&quot;, &quot;ghi&quot;, &quot;jkl&quot;, &quot;mno&quot;, &quot;pqrs&quot;, &quot;tuv&quot;, &quot;wxyz&quot; &#125;;</span><br><span class="line">		StringBuilder tmp = new StringBuilder();</span><br><span class="line">		result = new LinkedList&lt;String&gt;();</span><br><span class="line">		helper(table, 0, tmp, digits);</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private void helper(String[] table, int idx, StringBuilder tmp, String digits) &#123;</span><br><span class="line">		if (idx == digits.length()) &#123;</span><br><span class="line">			// 找到一种结果，加入到结果集中</span><br><span class="line">			if (tmp.length() != 0)</span><br><span class="line">				result.add(tmp.toString());</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			// 找出当前位数字对应可能的字母</span><br><span class="line">			String candidates = table[digits.charAt(idx) - &apos;0&apos;];</span><br><span class="line">			// 对每个可能的字母进行搜索</span><br><span class="line">			for (int i = 0; i &lt; candidates.length(); i++) &#123;</span><br><span class="line">				tmp.append(candidates.charAt(i));</span><br><span class="line">				helper(table, idx + 1, tmp, digits);</span><br><span class="line">				tmp.deleteCharAt(tmp.length() - 1);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>
    <div>
      
    </div>

    

    

    

   
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Iceberg</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/smarticeberg" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:icebergsmart@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.baidu.com" title="百度" target="_blank">百度</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Iceberg</span>

  
</div>


 <div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
